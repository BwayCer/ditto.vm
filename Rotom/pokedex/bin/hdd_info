#!/bin/bash
# 虛擬硬碟資訊


## info.txt
# <name>   <size>   [<start>-<end>/<number>]   [ <start> - <end> / <grainSector> (<grainSize>) ]


__dirname=`dirname $0`
binDirPath="$__dirname"


fnMain() {
    local vhddDirPath=`"$binDirPath/path.resolve" "$1"`


    if [ ! -f "$vhddDirPath/.info.tmp" ] \
        || [ -n "`cat "$vhddDirPath/info.txt" | sed -n "1p" | grep "^# overdue"`" ]
    then
        "$binDirPath/hdd_info_check" "$vhddDirPath"
        if [ $? -eq 1 ]; then exit 1; fi
    elif [ -n "`cat "$vhddDirPath/info.txt" | sed -n "3p"`" ]; then
        cat "$vhddDirPath/info.txt"
        exit
    fi


    local tmp
    local amount totalSize totalGrainSize
    local lenName lenSize lenNum lenGrainSector
    local vhddInfo vhddInfoSummary txtVhddInfo txtVhddInfoSummary

    vhddInfo=`cat "$vhddDirPath/.info.tmp"`

    if [ -z "$vhddInfo" ]; then
        cat /dev/null > "$vhddDirPath/info.txt"
        exit
    fi

    vhddInfoSummary=`echo -e "$vhddInfo" | sed -n "1p"`
    vhddInfo=`       echo -e "$vhddInfo" | sed    "1d"`


    amount=`        echo "$vhddInfoSummary" | cut -d " " -f 2`
    totalSize=`     echo "$vhddInfoSummary" | cut -d " " -f 4`
    totalGrainSize=`echo "$vhddInfoSummary" | cut -d " " -f 6`
    totalSize=`     "$binDirPath/sizeUnit" $totalSize`
    totalGrainSize=`"$binDirPath/sizeUnit" $(( $totalGrainSize * 1024 * 1024 ))`
    txtVhddInfoSummary="amount: $amount, totalSize: $totalSize, totalGrainSize: $totalGrainSize"


    txtVhddInfo=`echo -e "$vhddInfo" | cut -d " " -f 2,3,4,6`
    fnHandleVhddInfo "$txtVhddInfo"
    txtVhddInfo="$rtnHandleVhddInfo"

    lenName=`       echo -e "$txtVhddInfo" | cut -d " " -f 1 | wc -L`
    lenNum=`        echo -e "$txtVhddInfo" | cut -d " " -f 4 | wc -L`
    lenGrainSector=`echo -e "$txtVhddInfo" | cut -d " " -f 7 | wc -L`

    tmp=`        echo -e "$txtVhddInfo" | cut -d " " -f 2`
    tmp="$tmp\n"`echo -e "$txtVhddInfo" | cut -d " " -f 9`
    lenSize=`echo -e "$tmp" | wc -L`

    tmp="%-${lenName}s   %${lenSize}s   [%${lenNum}s-%${lenNum}s/%${lenNum}s]"
    tmp="$tmp   [ %${lenGrainSector}s - %${lenGrainSector}s / %${lenGrainSector}s (%${lenSize}s) ]\n"
    txtVhddInfo=`printf "$tmp" $txtVhddInfo | sed "1i $txtVhddInfoSummary\n"`


    echo "$txtVhddInfo" > "$vhddDirPath/info.txt"
    cat "$vhddDirPath/info.txt"
}


rtnHandleVhddInfo=""
fnHandleVhddInfo() {
    local txtVhddInfo="$1"

    local numNumber name size grainSizeM
    local recordName=""
    local recordSize=0
    local recordStartNum=0
    local recordEndNum=0
    local recordStartGrainSizeM=0
    local recordEndGrainSizeM=0

    local idx val
    local lenTxtVhddInfo=`echo -e "$txtVhddInfo" | wc -l`

    val=`echo -e "$txtVhddInfo" | sed -n "1p"`
    recordStartNum=`echo "$val" | cut -d " " -f 1`
    recordName=`    echo "$val" | cut -d " " -f 2`

    for idx in `seq 1 $lenTxtVhddInfo`
    do
        "$binDirPath/runingDot" $idx

        val=`echo -e "$txtVhddInfo" | sed -n "${idx}p"`
        numNumber=` echo "$val" | cut -d " " -f 1`
        name=`      echo "$val" | cut -d " " -f 2`
        size=`      echo "$val" | cut -d " " -f 3`
        grainSizeM=`echo "$val" | cut -d " " -f 4`

        if [ "$name" == "$recordName" ]; then
            recordSize=$(( $recordSize + $size ))
            recordEndNum=$numNumber
            recordEndGrainSizeM=$(( $recordEndGrainSizeM + $grainSizeM ))
        else
            fnResolveVhddInfo_record \
                $recordName $recordSize \
                $recordStartNum $recordEndNum \
                $recordStartGrainSizeM $recordEndGrainSizeM

            recordName="$name"
            recordStartNum=$numNumber
            recordStartGrainSizeM=$recordEndGrainSizeM

            recordSize=$size
            recordEndNum=$numNumber
            recordEndGrainSizeM=$(( $recordEndGrainSizeM + $grainSizeM ))
        fi
    done

    fnResolveVhddInfo_record \
        $recordName $recordSize \
        $recordStartNum $recordEndNum \
        $recordStartGrainSizeM $recordEndGrainSizeM


    rtnHandleVhddInfo=`echo -e "$rtnHandleVhddInfo" | sed "1d"`
}
fnResolveVhddInfo_record() {
    local recordName="$1"
    local recordSize=$2
    local recordStartNum=$3
    local recordEndNum=$4
    local recordStartGrainSizeM=$5
    local recordEndGrainSizeM=$6

    local totalGrainSizeM=$(( $recordEndGrainSizeM - $recordStartGrainSizeM ))
    local sizeUnit=`"$binDirPath/sizeUnit" $recordSize`
    local totalGrainSizeUnit=`"$binDirPath/sizeUnit" $(( $totalGrainSizeM * 1024 * 1024 ))`

    rtnHandleVhddInfo="$rtnHandleVhddInfo\n`printf "%s %s %s %s %s %s %s %s %s" \
        "$recordName" \
         $sizeUnit \
         $recordStartNum \
         $recordEndNum \
        $(( $recordEndNum - $recordStartNum + 1 )) \
        $(( $recordStartGrainSizeM * 1024 * 2 )) \
        $(( $recordEndGrainSizeM * 1024 * 2 - 1 )) \
        $(( $totalGrainSizeM * 1024 * 2 )) \
         $totalGrainSizeUnit`"
}


fnMain "$@"

